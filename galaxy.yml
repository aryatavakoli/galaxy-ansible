- name: Prepare Linux Enviroment
  hosts: galaxyservers
  become: yes
  roles:
    - geerlingguy.repo-epel
    - geerlingguy.git
    - geerlingguy.pip
    - jimbydamonk.libselinux-python

- hosts: galaxyservers
  become: yes
  pre_tasks:
    - name: Set timezone to PST
      become: yes
      timezone:
        name: America/Vancouver
    - name: Install packages
      yum:
        pkg: ['python-psycopg2', 'python-virtualenv', 'make', 'uwsgi', 'uwsgi-plugin-python2', 'libsemanage-python']
        update_cache: yes
        state: latest
    - name: Remove policycoreutils
      yum:
        name: policycoreutils-python
        state: absent
    - name: Install policycoreutils
      yum:
        name: policycoreutils-python
        state: latest
  handlers:
    - name: Restart Galaxy
      supervisorctl:
        name: galaxy
        state: restarted
  roles:
    - galaxyproject.postgresql
    - role: natefoo.postgresql_objects
      become: true
      become_user: postgres
    - galaxyproject.galaxy
    - uchida.miniconda
    - usegalaxy-eu.supervisor
    - galaxyproject.nginx
  post_tasks:
    - name: Install uwsgidecorators
      pip:
        name: uwsgidecorators
        virtualenv: "{{ galaxy_venv_dir }}"
    # - name: Add www-data to Galaxy group
    #   user:
    #     name: www-data
    #     groups: "{{user_group}}"

# - name: Install Dependecies for Interactive Environments 
#   hosts: galaxyservers
#   tasks:
#     - include: roles/galaxyproject.interactive_environments/tasks/install_dependencies.yml
#   post_tasks:
#   - name: Install pre-gyp with NPM
#     npm:
#       name: node-pre-gyp
#       global: yes

# - name: Setup Extra Roles
#   hosts: galaxyservers
#   become: yes
#   roles:
#    - vidtd
#    - galaxyproject.proftpd
#    - galaxyproject.galaxy-tools


# - name: setup local environment
#   hosts: galaxyservers
#   roles:
#    - galaxyproject.interactive_environments
