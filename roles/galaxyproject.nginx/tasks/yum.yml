---
- name: Install EPEL nginx repo
  become: yes
  become_user: root
  yum_repository:
    name: epel-nginx
    baseurl: https://depot.galaxyproject.org/yum/el/$releasever/$basearch/
    description: yum repo for galaxy repo
    gpgcheck: no
    enabled: yes

- name: Install EPEL nginx
  become: yes
  become_user: root
  yum:
    pkg: nginx
  notify:
    - restart nginx
    - supervisorctl restart nginx
  when: nginx_flavor != "galaxy"

- name: Install Galaxy nginx
  become: yes
  become_user: root
  yum:
    pkg: nginx-galaxy
  notify:
    - restart nginx
    - supervisorctl restart nginx
  when: nginx_flavor == "galaxy"

- name: Set permissions on temporary directories
  become: yes
  become_user: root
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nginx_conf_user | default('nginx') }}"
    group: "{{ nginx_conf_group | default('nginx') }}"
    mode: 0777
  with_items:
    - /var/lib/nginx
    - /var/lib/nginx/tmp

- name: Template nginx config file
  become: yes
  become_user: root
  template:
    src: epel-nginx.conf.j2
    dest: "{{ nginx_conf_dir }}/nginx.conf"
    backup: yes
  notify:
    - restart nginx
    - supervisorctl restart nginx

- name: Create virtual host directories
  become: yes
  become_user: root
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - "{{ nginx_conf_dir }}/sites-available"
    - "{{ nginx_conf_dir }}/sites-enabled"
  notify:
    - supervisorctl reload nginx

- name: Create config including virtual hosts
  become: yes
  become_user: root
  copy:
    dest: "{{ nginx_conf_dir }}/conf.d/sites-enabled.conf"
    content: |
      ## This file is maintained by Ansible - CHANGES WILL BE OVERWRITTEN
      include {{ nginx_conf_dir }}/sites-enabled/*;
  notify:
    - supervisorctl reload nginx

- name: Set default server redirection
  copy:
    dest: "{{ nginx_conf_dir }}/default.d/redirect.conf"
    content: |
      ## This file is maintained by Ansible - CHANGES WILL BE OVERWRITTEN
      return 302 {{ nginx_default_redirect_uri }};
  when: nginx_default_redirect_uri is defined
  notify:
    - supervisorctl reload nginx
